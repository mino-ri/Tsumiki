# Tsumiki.Core プロジェクト概要

## プロジェクト概要

VST3機能のメインロジックです。
このプロジェクト内のコードはパフォーマンスに配慮する必要があります。

## 属性レイヤリング

このプロジェクト内の全てのメソッド、コンストラクタ、構造体、static でないクラスは、次に示す「Timnig 属性」のうちどれか1つを持たなければなりません。
また、それぞれの属性に応じた制限に従わなければなりません。

- InitTimingAttribute
- EventTimingAttribute
- AudioTimingAttribute

get プロパティには Timing 属性をつける必要はありませんが、データの更新を**絶対に**行ってはいけません。
set プロパティは予測可能なデータの更新のみを行うものとし、その制限は「型に付けられた Timing 属性によるデータ更新制限」に順じます。

### 属性レイヤリングの例外

以下に示すファイルは、属性レイヤリングルールの対象外です。

- TsumikiProcessor.cs

### 属性によるメソッドの意味と制限

メソッドに付けられた Timing 属性は、そのメソッドがどの程度の頻度で呼び出されるかを表します。

#### InitTiming

- 制限はありません
- ヒープ上へのメモリ確保は InitTiming でのみ行うことができます
- EventTiming, AudioTiming 属性を持つメソッドを呼び出したり、データを変更することが許可されます

#### EventTiming

この処理は、1秒間に最大300回程度呼び出されます。

- InitTiming 属性を持つメソッドを**絶対に**呼び出してはいけません
- InitTiming 属性を持つ構造体のフィールドを**絶対に**変更してはいけません(読み取りは可)
- ヒープ上へのメモリ確保を**基本的に**行ってはいけません
- AudioTiming 属性を持つメソッドを呼び出したり、データを変更することが許可されます
- パフォーマンスに配慮した実装が必要ですが、コードの読みやすさが優先されます

#### AudioTiming

この処理は、1秒間に4万～5万回程度呼び出されます。

- InitTiming 属性を持つメソッドを**絶対に**呼び出してはいけません
- InitTiming 属性を持つ構造体のフィールドを**絶対に**変更してはいけません(読み取りは可)
- EventTiming 属性を持つメソッドを**基本的に**呼び出してはいけません
    - ただし、条件分岐などによって呼び出し回数が十分に少ないと予想できる場合のみ、 `// EVENT CALL` コメントをつけて呼び出すことができます
- EventTiming 属性を持つ構造体のフィールドを**基本的に**変更してはいけません(読み取りは可)
- ヒープ上へのメモリ確保を**絶対に**行ってはいけません
- コードの読みやすさよりもパフォーマンスを優先することができます

### 属性による型の意味と制限

型に付けられた Timing 属性は、その型が内包するデータがどの Timing 属性のメソッドから更新されるかを表します。
ただし、この属性は再帰的に引き継がれるものではありません。
